<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TCC Scheduled Interviews</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #3b82f6;
      --primary-extra-light: #dbeafe;
      --secondary-color: #64748b;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --background-primary: #f8fafc;
      --background-secondary: #ffffff;
      --background-tertiary: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      --border-color: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      --gradient-secondary: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-tertiary) 100%);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--background-primary) 0%, #e0f2fe 100%);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 13px;
      min-height: 100vh;
      animation: fadeInBody 0.6s ease-out;
    }
    
    @keyframes fadeInBody {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* PREMIUM GLASSMORPHISM EFFECTS */
    .glass {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .glass-dark {
      backdrop-filter: blur(20px);
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }

    /* INTEGRATED COMPACT HEADER */
    .dashboard-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      margin: 12px;
      margin-bottom: 16px;
      background: var(--glass);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .home-button {
      position: static;
      width: 36px;
      height: 36px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 16px;
      cursor: pointer;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      touch-action: manipulation;
      flex-shrink: 0;
      margin: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .home-button:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
    }

    .header-content {
      flex-grow: 1;
      text-align: center;
    }

    .dashboard-header h2 {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .dashboard-subtitle {
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 400;
      margin: 2px 0 0 0;
    }

    /* USER TYPE BADGE */
    .user-type-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 8px;
    }
    
    .user-type-admin {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .user-type-user {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary-color);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }

    /* DASHBOARD STYLES - Mobile First */
    #dashboard {
      display: block;
      animation: dashboardFadeIn 0.6s ease-out;
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 12px 12px 12px;
    }
    
    @keyframes dashboardFadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* MOBILE-FIRST FILTERS */
    .filters-container {
      background: var(--glass);
      padding: 16px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .filters-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .filters-title i {
      color: var(--primary-color);
      font-size: 12px;
    }
    
    .filters {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .filter-group label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    select, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 12px;
      background: var(--background-secondary);
      color: var(--text-primary);
      font-weight: 400;
      touch-action: manipulation;
    }
    
    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
    }

    /* COMPACT MOBILE-OPTIMIZED STATS */
    .stats-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: var(--glass);
      padding: 10px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    .stat-number {
      font-size: 18px;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 2px;
      line-height: 1;
    }

    .stat-label {
      font-size: 9px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      line-height: 1.2;
    }

    /* MOBILE-FRIENDLY TABLE */
    .table-container {
      background: var(--glass);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .table-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: var(--glass-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .table-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .table-title i {
      color: var(--primary-color);
      font-size: 12px;
    }

    .refresh-btn {
      padding: 6px 10px;
      font-size: 10px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      background: var(--gradient-primary);
      color: white;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      touch-action: manipulation;
    }

    .refresh-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      min-width: 900px;
    }
    
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      vertical-align: middle;
    }
    
    th {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    th i {
      margin-right: 4px;
      font-size: 8px;
    }
    
    tbody tr {
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    tbody tr:hover {
      background: rgba(37, 99, 235, 0.04);
    }
    
    tbody tr:nth-child(even) {
      background: rgba(248, 250, 252, 0.5);
    }
    
    tbody tr:nth-child(even):hover {
      background: rgba(37, 99, 235, 0.04);
    }
    
    tbody td {
      font-size: 10px;
      color: var(--text-primary);
      font-weight: 400;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* CLICKABLE CANDIDATE NAMES */
    .candidate-name-clickable {
      cursor: pointer !important;
      color: var(--primary-color) !important;
      font-weight: 600 !important;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .candidate-name-clickable:hover {
      color: var(--primary-dark) !important;
    }

    /* MOBILE-OPTIMIZED BADGES */
    .interview-badge {
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    
    .interview-upcoming {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary-color);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }
    
    .interview-today {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .interview-overdue {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .mode-badge {
      padding: 1px 4px;
      border-radius: var(--radius-sm);
      font-size: 7px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .mode-physical {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
    }

    .mode-online {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary-color);
    }

    /* POPUP STYLES */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255, 255, 255, 0.15);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(20px) saturate(180%);
      animation: overlayFadeIn 0.3s ease-out;
      padding: 16px;
    }
    
    @keyframes overlayFadeIn {
      from { opacity: 0; backdrop-filter: blur(0px); }
      to { opacity: 1; backdrop-filter: blur(20px) saturate(180%); }
    }
    
    .popup-content {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(40px) saturate(200%);
      padding: 24px;
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 450px;
      box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(255, 255, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      animation: popupSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      max-height: 85vh;
      overflow-y: auto;
    }
    
    .popup-content.compact {
      padding: 20px !important;
      max-width: 380px !important;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(40px) saturate(200%);
    }
    
    @keyframes popupSlideUp {
      from { opacity: 0; transform: translateY(40px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .popup-content h3 {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 20px;
      text-align: center;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .popup-info {
      background: rgba(37, 99, 235, 0.08);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      border: 1px solid rgba(37, 99, 235, 0.15);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .popup-info p {
      margin-bottom: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
    }
    
    .popup-info strong {
      color: var(--text-primary);
      font-weight: 700;
    }
    
    .popup-info span {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }
    
    .popup-content select, 
    .popup-content textarea, 
    .popup-content input {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--radius-md);
      font-size: 12px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .popup-content select:focus, 
    .popup-content textarea:focus, 
    .popup-content input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .popup-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    
    .popup-buttons .btn {
      backdrop-filter: blur(10px);
      font-weight: 600;
    }

    .btn {
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      touch-action: manipulation;
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }
    
    .btn-success:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.7);
      color: var(--text-primary);
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-primary);
      border-color: var(--primary-color);
    }

    /* LOADING STATES */
    .loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 30px;
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { opacity: 0.6; }
      to { opacity: 1; }
    }

    /* TABLET AND DESKTOP IMPROVEMENTS */
    @media (min-width: 480px) {
      .dashboard-header {
        padding: 14px 18px;
        gap: 14px;
        margin: 16px;
      }

      .home-button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }

      .dashboard-header h2 {
        font-size: 20px;
      }

      .dashboard-subtitle {
        font-size: 12px;
      }

      #dashboard {
        padding: 0 16px 16px 16px;
      }

      .filters {
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .stats-container {
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-bottom: 18px;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-number {
        font-size: 20px;
      }

      .stat-label {
        font-size: 10px;
      }
    }

    @media (min-width: 768px) {
      .dashboard-header {
        padding: 16px 20px;
        gap: 16px;
        margin: 20px;
        margin-bottom: 20px;
      }

      .home-button {
        width: 44px;
        height: 44px;
        font-size: 20px;
      }

      .dashboard-header h2 {
        font-size: 22px;
      }

      .dashboard-subtitle {
        font-size: 13px;
      }

      .filters-container {
        padding: 20px;
        margin-bottom: 20px;
      }

      .filters {
        grid-template-columns: repeat(2, 1fr);
      }

      .filters-title {
        font-size: 15px;
      }

      .stats-container {
        gap: 12px;
        margin-bottom: 20px;
      }

      .stat-card {
        padding: 14px;
        border-radius: var(--radius-lg);
      }

      .stat-number {
        font-size: 22px;
        margin-bottom: 3px;
      }

      .stat-label {
        font-size: 11px;
      }

      .table-header {
        padding: 16px 20px;
      }

      .table-title {
        font-size: 15px;
      }

      .refresh-btn {
        padding: 8px 12px;
        font-size: 11px;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 10px 12px;
      }

      th {
        font-size: 10px;
      }

      tbody td {
        font-size: 11px;
      }
    }

    @media (min-width: 1024px) {
      .filters {
        grid-template-columns: repeat(3, 1fr);
      }

      table {
        min-width: auto;
      }
    }

    /* PREMIUM SCROLLBAR */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--background-tertiary);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* ACCESSIBILITY */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    button:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }
  </style>
</head>
<body>

<!-- Integrated Compact Header -->
<div class="dashboard-header">
  <button class="home-button" onclick="goHome()" title="Home">
    🏠
  </button>
  <div class="header-content">
    <h2><i class="fas fa-calendar-check"></i> Scheduled Interviews</h2>
    <p class="dashboard-subtitle">
      All scheduled interviews in chronological order
      <span id="userTypeBadge" class="user-type-badge"></span>
    </p>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <!-- Filters -->
  <div class="filters-container">
    <h3 class="filters-title">
      <i class="fas fa-filter"></i>
      Filters
    </h3>
    <div class="filters">
      <div class="filter-group">
        <label>Company</label>
        <select id="companyFilter" onchange="applyFilters()">
          <option value="">All Companies</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Recruiter</label>
        <select id="recruiterFilter" onchange="applyFilters()">
          <option value="">All Recruiters</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Interview Status</label>
        <select id="statusFilter" onchange="applyFilters()">
          <option value="">All Status</option>
          <option value="today">Today</option>
          <option value="upcoming">Upcoming</option>
          <option value="overdue">Overdue</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-number" id="totalInterviews">0</div>
      <div class="stat-label">Total Scheduled</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="todayInterviews">0</div>
      <div class="stat-label">Today's Interviews</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="upcomingInterviews">0</div>
      <div class="stat-label">Upcoming</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="overdueInterviews">0</div>
      <div class="stat-label">Overdue</div>
    </div>
  </div>
  
  <div class="table-container">
    <div class="table-header">
      <h3 class="table-title">
        <i class="fas fa-clock"></i>
        Interview Schedule
      </h3>
      <button class="refresh-btn" onclick="loadScheduledInterviews()">
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
    </div>
    <div class="table-scroll">
      <table id="interviewTable">
        <thead>
          <tr>
            <th><i class="fas fa-calendar"></i> Interview Date</th>
            <th><i class="fas fa-user"></i> Candidate</th>
            <th><i class="fas fa-envelope"></i> Email</th>
            <th><i class="fas fa-briefcase"></i> Position</th>
            <th><i class="fas fa-building"></i> Company</th>
            <th><i class="fas fa-user-tie"></i> Recruiter</th>
            <th><i class="fas fa-map-marker-alt"></i> Mode</th>
            <th><i class="fas fa-flag"></i> Status</th>
            <th><i class="fas fa-info-circle"></i> Interview Status</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="9" class="loading">
            <i class="fas fa-spinner fa-spin"></i> 
            Loading scheduled interviews...
          </td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Candidate Options Popup -->
<div class="popup-overlay" id="candidateOptionsPopup">
  <div class="popup-content compact">
    <h3><i class="fas fa-user"></i> Candidate Actions</h3>
    
    <div style="text-align: center; margin-bottom: 20px;">
      <p id="popupCandidateNameDisplay" style="font-weight: bold; font-size: 14px; color: var(--text-primary);"></p>
    </div>
    
    <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;">
      <button class="btn btn-primary" id="btnUpdateStatus">
        <i class="fas fa-edit"></i>
        Update Status
      </button>
      <button class="btn btn-success" id="btnConnectWhatsapp">
        <i class="fab fa-whatsapp"></i>
        Connect WhatsApp
      </button>
    </div>
    
    <div style="text-align: center;">
      <button class="btn btn-secondary" onclick="closeCandidateOptionsPopup()">
        <i class="fas fa-times"></i>
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Status Update Popup (same as management page) -->
<div class="popup-overlay" id="popup">
  <div class="popup-content">
    <h3><i class="fas fa-edit"></i> Update Status</h3>
    
    <div class="popup-info">
      <p><strong>Name:</strong> <span id="popupCandidateName"></span></p>
      <p><strong>Company:</strong> <span id="popupCompany"></span></p>
      <p><strong>Position:</strong> <span id="popupPosition"></span></p>
      <p><strong>__powerappsid__:</strong> <span id="popup__powerappsid__"></span></p>
    </div>
    
    <div class="form-group">
      <label for="statusDropdown"><i class="fas fa-flag"></i> Status</label>
      <select id="statusDropdown" onchange="updateFinalStatusOptions()">
        <option value="">Select Status</option>
        <option value="Selected">Selected</option>
        <option value="Rejected">Rejected</option>
        <option value="On Hold">On Hold</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="finalStatusDropdown"><i class="fas fa-check-circle"></i> Final Status</label>
      <select id="finalStatusDropdown">
        <option value="">Select Final Status</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="commentBox"><i class="fas fa-comment"></i> Comment</label>
      <textarea id="commentBox" rows="2" placeholder="Optional comment..."></textarea>
    </div>
    
    <div class="popup-buttons">
      <button class="btn btn-secondary" onclick="closePopup()">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button class="btn btn-primary" id="statusSubmitButton" onclick="submitFinalStatusUpdate()">
        <i class="fas fa-save"></i>
        <span class="btn-text">Update</span>
      </button>
    </div>
  </div>
</div>

<script>
// Authentication and user data management
window.addEventListener('load', function() {
    console.log("Scheduled Interviews page loaded - checking authentication...");
    
    // Get all user data from sessionStorage
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    const userEmail = sessionStorage.getItem('userEmail');
    const userName = sessionStorage.getItem('userName');
    const userContact = sessionStorage.getItem('userContact');
    const userDesignation = sessionStorage.getItem('userDesignation');
    const userType = sessionStorage.getItem('userType');
    const loginTime = sessionStorage.getItem('loginTime');
    
    // Check if user is authenticated
    if (isLoggedIn !== 'true') {
        alert("Session expired or not logged in. Redirecting to login page.");
        window.location.href = 'index.html';
        return;
    }
    
    // User is authenticated
    console.log('✓ User authenticated successfully');
    
    // Set loggedInEmail to the authenticated user's email
    loggedInEmail = userEmail;
    
    // Store user data globally for easy access
    window.USER_DATA = {
        isLoggedIn: isLoggedIn === 'true',
        email: userEmail,
        name: userName,
        contact: userContact,
        designation: userDesignation,
        userType: userType,
        loginTime: loginTime
    };
    
    console.log('User data available globally as window.USER_DATA:', window.USER_DATA);
    
    // Display user type badge
    displayUserTypeBadge();
    
    // Load scheduled interviews
    loadScheduledInterviews();
});

// Display user type badge
function displayUserTypeBadge() {
    const badge = document.getElementById('userTypeBadge');
    const userType = sessionStorage.getItem('userType');
    
    if (badge && userType) {
        const type = userType.toLowerCase();
        badge.textContent = userType.toUpperCase();
        
        if (type === 'admin') {
            badge.className = 'user-type-badge user-type-admin';
        } else {
            badge.className = 'user-type-badge user-type-user';
        }
    }
}

// NEW: Role-based candidate filtering function
function filterCandidatesByUserType(data) {
    const userData = {
        userType: sessionStorage.getItem('userType'),
        email: sessionStorage.getItem('userEmail')
    };
    
    // If user is Admin, show all candidates
    if (userData.userType && userData.userType.toLowerCase() === 'admin') {
        console.log('✓ Admin user detected - showing ALL scheduled interviews');
        return data;
    } else {
        // If user is regular User, show only their candidates
        console.log('✓ Regular user detected - filtering by recruiter email');
        return data.filter(c => (c.recruiter || "").toLowerCase() === (userData.email || "").toLowerCase());
    }
}

// Global variables
let loggedInEmail = "";
let allScheduledInterviews = []; // Store all interviews
let filteredInterviews = []; // Store filtered interviews
let currentCandidateForPopup = null; // For popup actions
let currentEmail = ""; // For status updates
const dataURL = "https://script.google.com/macros/s/AKfycbwhlc_lnb2OaC-W1g2WGI0X15H4VmzykIg_FejVvucVqtEc-mO65vU1_QOPY0YBQ1HU/exec";
const postURL = "https://script.google.com/macros/s/AKfycbwAru_5iah71LYYqh5CNrdt13tNP2sWLy7yzhbnNel2Q1wsojRRTYgn_wawfLHttN9R/exec";

// Helper functions
function goHome() {
    window.location.href = 'index.html';
}

function getElement(id) {
  const element = document.getElementById(id);
  if (!element) {
    console.error(`Element with id '${id}' not found`);
  }
  return element;
}

function formatInterviewDateTime(dt) {
  if (!dt) return "N/A";
  try {
    const d = new Date(dt);
    if (isNaN(d.getTime())) return dt;
    
    const options = {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    };
    
    return d.toLocaleDateString('en-IN', options);
  } catch (error) {
    console.error("Error formatting interview date:", error);
    return dt;
  }
}

function getInterviewStatus(interviewDate) {
  if (!interviewDate) return { class: '', text: 'Not Scheduled' };
  
  try {
    const now = new Date();
    const interview = new Date(interviewDate);
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const interviewDay = new Date(interview.getFullYear(), interview.getMonth(), interview.getDate());
    
    if (interview < now) {
      return { class: 'interview-overdue', text: 'Overdue' };
    } else if (interviewDay.getTime() === today.getTime()) {
      return { class: 'interview-today', text: 'Today' };
    } else {
      return { class: 'interview-upcoming', text: 'Upcoming' };
    }
  } catch (error) {
    return { class: '', text: 'Invalid Date' };
  }
}

function escapeHtml(unsafe) {
  return (unsafe || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Popup functions
function openCandidateOptionsPopup(candidate) {
  const popup = getElement('candidateOptionsPopup');
  const nameDisplay = getElement('popupCandidateNameDisplay');
  
  if (!popup || !nameDisplay) return;

  currentCandidateForPopup = candidate;
  nameDisplay.textContent = candidate.name || "";
  popup.style.display = 'flex';
}

function closeCandidateOptionsPopup() {
  const popup = getElement('candidateOptionsPopup');
  if (popup) popup.style.display = 'none';
  currentCandidateForPopup = null;
}

// Status update functions (from management page)
function openPopup(candidate) {
  currentEmail = candidate.email;
  const elements = {
    candidateName: getElement("popupCandidateName"),
    company: getElement("popupCompany"),
    position: getElement("popupPosition"),
    powerAppsId: getElement("popup__powerappsid__"),
    statusDropdown: getElement("statusDropdown"),
    finalStatusDropdown: getElement("finalStatusDropdown"),
    commentBox: getElement("commentBox"),
    popup: getElement("popup")
  };
  
  if (elements.candidateName) elements.candidateName.textContent = candidate.name || "";
  if (elements.company) elements.company.textContent = candidate.company || "";
  if (elements.position) elements.position.textContent = candidate.position || "";
  
  if (elements.powerAppsId) {
    elements.powerAppsId.textContent = candidate.__powerappsid__ || "Not Available";
  }
  
  if (elements.statusDropdown) elements.statusDropdown.value = "";
  if (elements.finalStatusDropdown) elements.finalStatusDropdown.innerHTML = '<option value="">Select Final Status</option>';
  if (elements.commentBox) elements.commentBox.value = "";
  if (elements.popup) elements.popup.style.display = "flex";
}

function closePopup() {
  const popup = getElement("popup");
  if (popup) popup.style.display = "none";
}

function updateFinalStatusOptions() {
  const statusDropdown = getElement("statusDropdown");
  const finalStatusDropdown = getElement("finalStatusDropdown");
  if (!statusDropdown || !finalStatusDropdown) return;
  
  const status = statusDropdown.value;
  finalStatusDropdown.innerHTML = '<option value="">Select Final Status</option>';
  
  const statusOptions = {
    "Selected": ["Shortlisted", "L1 Selected", "L2 Selected", "L3 Selected", "Final Select"],
    "Rejected": ["Not Shortlisted", "L1 Reject", "L2 Reject", "L3 Reject"],
    "On Hold": ["Position On Hold", "Candidate On Hold"]
  };
  
  (statusOptions[status] || []).forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    finalStatusDropdown.appendChild(opt);
  });
}

function submitFinalStatusUpdate() {
  const statusDropdown = getElement("statusDropdown");
  const finalStatusDropdown = getElement("finalStatusDropdown");
  const commentBox = getElement("commentBox");
  
  if (!statusDropdown || !finalStatusDropdown || !commentBox) {
    alert("Form elements not found");
    return;
  }
  
  const status = statusDropdown.value;
  const finalStatus = finalStatusDropdown.value;
  const comment = commentBox.value;
  
  if (!currentEmail || !status || !finalStatus) {
    alert("Please select both status and final status.");
    return;
  }
  
  // Show loading state
  const submitButton = getElement('statusSubmitButton');
  if (submitButton) {
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
  }
  
  fetch(postURL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      email: currentEmail, 
      status, 
      final_status: finalStatus, 
      comment 
    })
  })
  .then(() => {
    setTimeout(() => {
      alert("Status updated successfully!");
      closePopup();
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-save"></i> <span class="btn-text">Update</span>';
      }
      loadScheduledInterviews(); // Reload data
    }, 1000);
  })
  .catch(error => {
    console.error("Fetch failed:", error);
    setTimeout(() => {
      alert("Update failed. Please try again.");
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-save"></i> <span class="btn-text">Update</span>';
      }
    }, 1000);
  });
}

// Load filter options
function loadFilterOptions() {
  const companyFilter = getElement('companyFilter');
  const recruiterFilter = getElement('recruiterFilter');
  
  if (!companyFilter || !recruiterFilter) return;
  
  // Get unique companies
  const companies = [...new Set(allScheduledInterviews.map(interview => interview.company).filter(Boolean))];
  companyFilter.innerHTML = '<option value="">All Companies</option>';
  companies.forEach(company => {
    const opt = document.createElement('option');
    opt.value = company;
    opt.textContent = company;
    companyFilter.appendChild(opt);
  });
  
  // Get unique recruiters
  const recruiters = [...new Set(allScheduledInterviews.map(interview => interview.recruiter).filter(Boolean))];
  recruiterFilter.innerHTML = '<option value="">All Recruiters</option>';
  recruiters.forEach(recruiter => {
    const opt = document.createElement('option');
    opt.value = recruiter;
    opt.textContent = recruiter.split('@')[0]; // Show only name part
    recruiterFilter.appendChild(opt);
  });
}

// Apply filters
function applyFilters() {
  const companyFilter = getElement('companyFilter');
  const recruiterFilter = getElement('recruiterFilter');
  const statusFilter = getElement('statusFilter');
  
  const selectedCompany = companyFilter ? companyFilter.value : '';
  const selectedRecruiter = recruiterFilter ? recruiterFilter.value : '';
  const selectedStatus = statusFilter ? statusFilter.value : '';
  
  filteredInterviews = allScheduledInterviews.filter(interview => {
    // Company filter
    const matchCompany = !selectedCompany || interview.company === selectedCompany;
    
    // Recruiter filter
    const matchRecruiter = !selectedRecruiter || interview.recruiter === selectedRecruiter;
    
    // Status filter
    let matchStatus = true;
    if (selectedStatus) {
      const interviewStatus = getInterviewStatus(interview.interview_date);
      matchStatus = interviewStatus.text.toLowerCase() === selectedStatus;
    }
    
    return matchCompany && matchRecruiter && matchStatus;
  });
  
  renderInterviewTable();
}

function updateStats() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  let totalInterviews = filteredInterviews.length;
  let todayCount = 0;
  let upcomingCount = 0;
  let overdueCount = 0;
  
  filteredInterviews.forEach(interview => {
    if (!interview.interview_date) return;
    
    try {
      const interviewDate = new Date(interview.interview_date);
      const interviewDay = new Date(interviewDate.getFullYear(), interviewDate.getMonth(), interviewDate.getDate());
      
      if (interviewDate < now) {
        overdueCount++;
      } else if (interviewDay.getTime() === today.getTime()) {
        todayCount++;
      } else {
        upcomingCount++;
      }
    } catch (error) {
      console.error("Error processing interview date:", error);
    }
  });
  
  // Update stats display
  const totalEl = getElement('totalInterviews');
  const todayEl = getElement('todayInterviews');
  const upcomingEl = getElement('upcomingInterviews');
  const overdueEl = getElement('overdueInterviews');
  
  if (totalEl) totalEl.textContent = totalInterviews;
  if (todayEl) todayEl.textContent = todayCount;
  if (upcomingEl) upcomingEl.textContent = upcomingCount;
  if (overdueEl) overdueEl.textContent = overdueCount;
}

function renderInterviewTable() {
  const tableBody = document.querySelector("#interviewTable tbody");
  if (!tableBody) return;
  
  tableBody.innerHTML = "";
  
  if (filteredInterviews.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px;"><i class="fas fa-calendar-times" style="color: var(--text-tertiary);"></i><br>No scheduled interviews found</td></tr>';
    updateStats();
    return;
  }
  
  filteredInterviews.forEach((interview, index) => {
    const row = document.createElement("tr");
    const safeName = escapeHtml(interview.name || "");
    const interviewStatus = getInterviewStatus(interview.interview_date);
    
    // Determine interview mode badge
    let modeBadge = '<span class="mode-badge">Unknown</span>';
    if (interview.interview_mode) {
      const mode = interview.interview_mode.toLowerCase();
      if (mode === 'physical') {
        modeBadge = '<span class="mode-badge mode-physical">Physical</span>';
      } else if (mode === 'online') {
        modeBadge = '<span class="mode-badge mode-online">Online</span>';
      }
    }
    
    row.innerHTML = `
      <td title="${formatInterviewDateTime(interview.interview_date)}"><strong>${formatInterviewDateTime(interview.interview_date)}</strong></td>
      <td title="${safeName}" class="candidate-name-clickable" data-index="${index}"><strong>${safeName}</strong></td>
      <td title="${escapeHtml(interview.email || '')}">${escapeHtml(interview.email || "")}</td>
      <td title="${escapeHtml(interview.position || '')}">${escapeHtml(interview.position || "")}</td>
      <td title="${escapeHtml(interview.company || '')}">${escapeHtml(interview.company || "")}</td>
      <td>${escapeHtml((interview.recruiter || '').split("@")[0])}</td>
      <td>${modeBadge}</td>
      <td title="${escapeHtml(interview.final_status || '')}">${escapeHtml(interview.final_status || "Pending")}</td>
      <td><span class="interview-badge ${interviewStatus.class}">${interviewStatus.text}</span></td>
    `;
    
    tableBody.appendChild(row);
  });
  
  // Add click handlers to candidate names
  tableBody.querySelectorAll('.candidate-name-clickable').forEach(nameCell => {
    nameCell.addEventListener('click', (event) => {
      event.stopPropagation();
      const index = parseInt(event.currentTarget.getAttribute('data-index'));
      const candidate = filteredInterviews[index];
      if (candidate) {
        openCandidateOptionsPopup(candidate);
      }
    });
  });
  
  // Update statistics
  updateStats();
}

// UPDATED: loadScheduledInterviews with role-based filtering
function loadScheduledInterviews() {
  console.log("Loading scheduled interviews...");
  
  fetch(dataURL)
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      if (!Array.isArray(data)) {
        throw new Error("Expected array data");
      }
      
      console.log("Raw data received:", data.length, "records");
      
      // NEW: Apply role-based filtering first, then filter for interview dates
      const roleFilteredCandidates = filterCandidatesByUserType(data);
      const userCandidates = roleFilteredCandidates.filter(c => {
        const hasInterviewDate = c.interview_date && c.interview_date.trim() !== "";
        return hasInterviewDate;
      });
      
      console.log("Role-filtered candidates with interview dates:", userCandidates.length);
      
      // Sort by interview_date in ascending order
      allScheduledInterviews = userCandidates.sort((a, b) => {
        try {
          const dateA = new Date(a.interview_date);
          const dateB = new Date(b.interview_date);
          return dateA - dateB;
        } catch (error) {
          console.error("Error sorting dates:", error);
          return 0;
        }
      });
      
      console.log("Sorted scheduled interviews:", allScheduledInterviews.length);
      
      // Initialize filtered interviews
      filteredInterviews = [...allScheduledInterviews];
      
      // Load filter options
      loadFilterOptions();
      
      // Render table
      renderInterviewTable();
    })
    .catch(err => {
      console.error("Error loading scheduled interviews:", err);
      const tableBody = document.querySelector("#interviewTable tbody");
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px;"><i class="fas fa-exclamation-triangle" style="color: var(--error-color);"></i><br>Error loading data. Please refresh.</td></tr>';
      }
    });
}

// Initialize popup event handlers after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Update Status button handler
  const btnUpdateStatus = getElement('btnUpdateStatus');
  if (btnUpdateStatus) {
    btnUpdateStatus.addEventListener('click', () => {
      if (!currentCandidateForPopup) {
        alert('No candidate selected');
        return;
      }
      openPopup(currentCandidateForPopup);
      closeCandidateOptionsPopup();
    });
  }

  // Connect WhatsApp button handler
  const btnConnectWhatsapp = getElement('btnConnectWhatsapp');
  if (btnConnectWhatsapp) {
    btnConnectWhatsapp.addEventListener('click', () => {
      if (!currentCandidateForPopup) {
        alert('No candidate selected');
        return;
      }

      // Get mobile number from candidate data
      const mobileRaw = currentCandidateForPopup.Mobile || 
                       currentCandidateForPopup.mobile || 
                       currentCandidateForPopup.Phone || 
                       currentCandidateForPopup.phone || '';
      
      if (!mobileRaw) {
        alert('Mobile number not available for this candidate');
        return;
      }

      // Extract digits only
      const digitsOnly = mobileRaw.toString().replace(/\D/g, '');
      if (!digitsOnly) {
        alert('Invalid mobile number');
        return;
      }

      // Open WhatsApp
      const waUrl = `https://wa.me/91${digitsOnly}`;
      window.open(waUrl, '_blank');
      closeCandidateOptionsPopup();
    });
  }
});

console.log('Scheduled Interviews page loaded with authentication integration, popup functionality, and role-based filtering');
</script>
</body>
</html>
