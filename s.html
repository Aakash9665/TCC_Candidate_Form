<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TCC Scheduled Interviews</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #3b82f6;
      --primary-extra-light: #dbeafe;
      --secondary-color: #64748b;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --background-primary: #f8fafc;
      --background-secondary: #ffffff;
      --background-tertiary: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      --border-color: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      --gradient-secondary: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-tertiary) 100%);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--background-primary) 0%, #e0f2fe 100%);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 13px;
      min-height: 100vh;
      animation: fadeInBody 0.6s ease-out;
    }
    
    @keyframes fadeInBody {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Home Button */
    .home-button {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 25px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1000;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .home-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }

    .home-button:hover::before {
      left: 100%;
    }

    .home-button:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 12px 40px rgba(255, 255, 255, 0.2);
    }

    /* PREMIUM GLASSMORPHISM EFFECTS */
    .glass {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .glass-dark {
      backdrop-filter: blur(20px);
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }

    /* DASHBOARD STYLES */
    #dashboard {
      display: block;
      animation: dashboardFadeIn 0.6s ease-out;
      max-width: 1600px;
      margin: 0 auto;
      padding: 16px;
    }
    
    @keyframes dashboardFadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .dashboard-header {
      text-align: center;
      margin-bottom: 24px;
      padding: 20px;
      background: var(--glass);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
    }
    
    .dashboard-header h2 {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 4px;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .dashboard-subtitle {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 400;
    }

    /* STATS CARDS */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--glass);
      padding: 20px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    .stat-number {
      font-size: 28px;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* TABLE STYLES */
    .table-container {
      background: var(--glass);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .table-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: var(--glass-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .table-title i {
      color: var(--primary-color);
      font-size: 14px;
    }

    .refresh-btn {
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      background: var(--gradient-primary);
      color: white;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .refresh-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      vertical-align: middle;
    }
    
    th {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    th i {
      margin-right: 4px;
      font-size: 9px;
    }
    
    tbody tr {
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    tbody tr:hover {
      background: rgba(37, 99, 235, 0.04);
      transform: scale(1.001);
    }
    
    tbody tr:nth-child(even) {
      background: rgba(248, 250, 252, 0.5);
    }
    
    tbody tr:nth-child(even):hover {
      background: rgba(37, 99, 235, 0.04);
    }
    
    tbody td {
      font-size: 11px;
      color: var(--text-primary);
      font-weight: 400;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* INTERVIEW STATUS BADGES */
    .interview-badge {
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .interview-upcoming {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary-color);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }
    
    .interview-today {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .interview-overdue {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* MODE BADGES */
    .mode-badge {
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 8px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .mode-physical {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
    }

    .mode-online {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary-color);
    }

    /* LOADING STATES */
    .loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px;
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { opacity: 0.6; }
      to { opacity: 1; }
    }

    /* RESPONSIVE */
    @media (max-width: 1200px) {
      .stats-container {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
    }
    
    @media (max-width: 768px) {
      #dashboard {
        padding: 12px;
      }
      
      .dashboard-header {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .dashboard-header h2 {
        font-size: 20px;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      table {
        min-width: 1000px;
      }
      
      th, td {
        padding: 8px 10px;
        font-size: 10px;
      }

      .home-button {
        top: 15px;
        left: 15px;
        width: 45px;
        height: 45px;
        font-size: 18px;
        border-radius: 22.5px;
      }

      .table-header {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
    }

    /* PREMIUM SCROLLBAR */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--background-tertiary);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>

<!-- Home Button -->
<button class="home-button" onclick="goHome()" title="Home">
  🏠
</button>

<!-- Dashboard -->
<div id="dashboard">
  <div class="dashboard-header">
    <h2><i class="fas fa-calendar-check"></i> Scheduled Interviews</h2>
    <p class="dashboard-subtitle">All scheduled interviews in chronological order</p>
  </div>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-number" id="totalInterviews">0</div>
      <div class="stat-label">Total Scheduled</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="todayInterviews">0</div>
      <div class="stat-label">Today's Interviews</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="upcomingInterviews">0</div>
      <div class="stat-label">Upcoming</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="overdueInterviews">0</div>
      <div class="stat-label">Overdue</div>
    </div>
  </div>
  
  <div class="table-container">
    <div class="table-header">
      <h3 class="table-title">
        <i class="fas fa-clock"></i>
        Interview Schedule
      </h3>
      <button class="refresh-btn" onclick="loadScheduledInterviews()">
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
    </div>
    <table id="interviewTable">
      <thead>
        <tr>
          <th><i class="fas fa-calendar"></i> Interview Date</th>
          <th><i class="fas fa-user"></i> Candidate</th>
          <th><i class="fas fa-envelope"></i> Email</th>
          <th><i class="fas fa-briefcase"></i> Position</th>
          <th><i class="fas fa-building"></i> Company</th>
          <th><i class="fas fa-user-tie"></i> Recruiter</th>
          <th><i class="fas fa-map-marker-alt"></i> Mode</th>
          <th><i class="fas fa-flag"></i> Status</th>
          <th><i class="fas fa-info-circle"></i> Interview Status</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="9" class="loading">
          <i class="fas fa-spinner fa-spin"></i> 
          Loading scheduled interviews...
        </td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
// Authentication and user data management
window.addEventListener('load', function() {
    console.log("Scheduled Interviews page loaded - checking authentication...");
    
    // Get all user data from sessionStorage
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    const userEmail = sessionStorage.getItem('userEmail');
    const userName = sessionStorage.getItem('userName');
    const userContact = sessionStorage.getItem('userContact');
    const userDesignation = sessionStorage.getItem('userDesignation');
    const userType = sessionStorage.getItem('userType');
    const loginTime = sessionStorage.getItem('loginTime');
    
    // Check if user is authenticated
    if (isLoggedIn !== 'true') {
        alert("Session expired or not logged in. Redirecting to login page.");
        window.location.href = 'index.html';
        return;
    }
    
    // User is authenticated - display user info
    console.log('✓ User authenticated successfully');
    console.log('User Details:', {
        name: userName,
        email: userEmail,
        contact: userContact,
        designation: userDesignation,
        userType: userType,
        loginTime: loginTime
    });
    
    // Set loggedInEmail to the authenticated user's email
    loggedInEmail = userEmail;
    
    // Store user data globally for easy access
    window.USER_DATA = {
        isLoggedIn: isLoggedIn === 'true',
        email: userEmail,
        name: userName,
        contact: userContact,
        designation: userDesignation,
        userType: userType,
        loginTime: loginTime
    };
    
    console.log('User data available globally as window.USER_DATA:', window.USER_DATA);
    
    // Load scheduled interviews
    loadScheduledInterviews();
});

// Global variables
let loggedInEmail = "";
let scheduledInterviews = [];
const dataURL = "https://script.google.com/macros/s/AKfycbwhlc_lnb2OaC-W1g2WGI0X15H4VmzykIg_FejVvucVqtEc-mO65vU1_QOPY0YBQ1HU/exec";

// Helper functions
function goHome() {
    window.location.href = 'index.html';
}

function getElement(id) {
  const element = document.getElementById(id);
  if (!element) {
    console.error(`Element with id '${id}' not found`);
  }
  return element;
}

function formatInterviewDateTime(dt) {
  if (!dt) return "N/A";
  try {
    const d = new Date(dt);
    if (isNaN(d.getTime())) return dt;
    
    const options = {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    };
    
    return d.toLocaleDateString('en-IN', options);
  } catch (error) {
    console.error("Error formatting interview date:", error);
    return dt;
  }
}

function getInterviewStatus(interviewDate) {
  if (!interviewDate) return { class: '', text: 'Not Scheduled' };
  
  try {
    const now = new Date();
    const interview = new Date(interviewDate);
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const interviewDay = new Date(interview.getFullYear(), interview.getMonth(), interview.getDate());
    
    if (interview < now) {
      return { class: 'interview-overdue', text: 'Overdue' };
    } else if (interviewDay.getTime() === today.getTime()) {
      return { class: 'interview-today', text: 'Today' };
    } else {
      return { class: 'interview-upcoming', text: 'Upcoming' };
    }
  } catch (error) {
    return { class: '', text: 'Invalid Date' };
  }
}

function escapeHtml(unsafe) {
  return (unsafe || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function updateStats() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  let totalInterviews = scheduledInterviews.length;
  let todayCount = 0;
  let upcomingCount = 0;
  let overdueCount = 0;
  
  scheduledInterviews.forEach(interview => {
    if (!interview.interview_date) return;
    
    try {
      const interviewDate = new Date(interview.interview_date);
      const interviewDay = new Date(interviewDate.getFullYear(), interviewDate.getMonth(), interviewDate.getDate());
      
      if (interviewDate < now) {
        overdueCount++;
      } else if (interviewDay.getTime() === today.getTime()) {
        todayCount++;
      } else {
        upcomingCount++;
      }
    } catch (error) {
      console.error("Error processing interview date:", error);
    }
  });
  
  // Update stats display
  const totalEl = getElement('totalInterviews');
  const todayEl = getElement('todayInterviews');
  const upcomingEl = getElement('upcomingInterviews');
  const overdueEl = getElement('overdueInterviews');
  
  if (totalEl) totalEl.textContent = totalInterviews;
  if (todayEl) todayEl.textContent = todayCount;
  if (upcomingEl) upcomingEl.textContent = upcomingCount;
  if (overdueEl) overdueEl.textContent = overdueCount;
}

function renderInterviewTable() {
  const tableBody = document.querySelector("#interviewTable tbody");
  if (!tableBody) return;
  
  tableBody.innerHTML = "";
  
  if (scheduledInterviews.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px;"><i class="fas fa-calendar-times" style="color: var(--text-tertiary);"></i><br>No scheduled interviews found</td></tr>';
    return;
  }
  
  scheduledInterviews.forEach(interview => {
    const row = document.createElement("tr");
    const safeName = escapeHtml(interview.name || "");
    const interviewStatus = getInterviewStatus(interview.interview_date);
    
    // Determine interview mode badge
    let modeBadge = '<span class="mode-badge">Unknown</span>';
    if (interview.interview_mode) {
      const mode = interview.interview_mode.toLowerCase();
      if (mode === 'physical') {
        modeBadge = '<span class="mode-badge mode-physical">Physical</span>';
      } else if (mode === 'online') {
        modeBadge = '<span class="mode-badge mode-online">Online</span>';
      }
    }
    
    row.innerHTML = `
      <td title="${formatInterviewDateTime(interview.interview_date)}"><strong>${formatInterviewDateTime(interview.interview_date)}</strong></td>
      <td title="${safeName}"><strong>${safeName}</strong></td>
      <td title="${escapeHtml(interview.email || '')}">${escapeHtml(interview.email || "")}</td>
      <td title="${escapeHtml(interview.position || '')}">${escapeHtml(interview.position || "")}</td>
      <td title="${escapeHtml(interview.company || '')}">${escapeHtml(interview.company || "")}</td>
      <td>${escapeHtml((interview.recruiter || '').split("@")[0])}</td>
      <td>${modeBadge}</td>
      <td title="${escapeHtml(interview.final_status || '')}">${escapeHtml(interview.final_status || "Pending")}</td>
      <td><span class="interview-badge ${interviewStatus.class}">${interviewStatus.text}</span></td>
    `;
    
    tableBody.appendChild(row);
  });
  
  // Update statistics
  updateStats();
}

function loadScheduledInterviews() {
  console.log("Loading scheduled interviews...");
  
  fetch(dataURL)
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      if (!Array.isArray(data)) {
        throw new Error("Expected array data");
      }
      
      console.log("Raw data received:", data.length, "records");
      
      // Filter for user's candidates that have interview_date
      const userCandidates = data.filter(c => {
        const hasRecruiter = (c.recruiter || "").toLowerCase() === loggedInEmail.toLowerCase();
        const hasInterviewDate = c.interview_date && c.interview_date.trim() !== "";
        return hasRecruiter && hasInterviewDate;
      });
      
      console.log("Filtered candidates with interview dates:", userCandidates.length);
      
      // Sort by interview_date in ascending order
      scheduledInterviews = userCandidates.sort((a, b) => {
        try {
          const dateA = new Date(a.interview_date);
          const dateB = new Date(b.interview_date);
          return dateA - dateB;
        } catch (error) {
          console.error("Error sorting dates:", error);
          return 0;
        }
      });
      
      console.log("Sorted scheduled interviews:", scheduledInterviews.length);
      
      renderInterviewTable();
    })
    .catch(err => {
      console.error("Error loading scheduled interviews:", err);
      const tableBody = document.querySelector("#interviewTable tbody");
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px;"><i class="fas fa-exclamation-triangle" style="color: var(--error-color);"></i><br>Error loading data. Please refresh.</td></tr>';
      }
    });
}

console.log('Scheduled Interviews page loaded with authentication integration');
</script>
</body>
</html>
