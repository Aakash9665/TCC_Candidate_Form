<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TCC Candidate Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #3b82f6;
      --primary-extra-light: #dbeafe;
      --secondary-color: #64748b;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --background-primary: #f8fafc;
      --background-secondary: #ffffff;
      --background-tertiary: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      --border-color: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      --gradient-secondary: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-tertiary) 100%);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--background-primary) 0%, #e0f2fe 100%);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 13px;
      min-height: 100vh;
      animation: fadeInBody 0.6s ease-out;
    }
    
    @keyframes fadeInBody {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Home Button */
    .home-button {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 25px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1000;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .home-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }

    .home-button:hover::before {
      left: 100%;
    }

    .home-button:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 12px 40px rgba(255, 255, 255, 0.2);
    }

    /* PREMIUM GLASSMORPHISM EFFECTS */
    .glass {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .glass-dark {
      backdrop-filter: blur(20px);
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }
    
    /* LOADING SPINNER */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s ease-in-out infinite;
      margin-right: 8px;
    }
    
    /* COMPACT DASHBOARD STYLES */
    #dashboard {
      display: block;
      animation: dashboardFadeIn 0.6s ease-out;
      max-width: 1600px;
      margin: 0 auto;
      padding: 16px;
    }
    
    @keyframes dashboardFadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .dashboard-header {
      text-align: center;
      margin-bottom: 24px;
      padding: 20px;
      background: var(--glass);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
    }
    
    .dashboard-header h2 {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 4px;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .dashboard-subtitle {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 400;
    }
    
    /* COMPACT FILTERS */
    .filters-container {
      background: var(--glass);
      padding: 20px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .filters-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .filters-title i {
      color: var(--primary-color);
      font-size: 14px;
    }
    
    .filters {
      display: grid;
      grid-template-columns: 2fr 1fr 1.5fr 1.5fr;
      gap: 16px;
      align-items: end;
    }
    
    .filter-group label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-with-icon i {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
      z-index: 1;
      font-size: 12px;
    }
    
    select, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 12px;
      background: var(--background-secondary);
      color: var(--text-primary);
      font-weight: 400;
    }
    
    .input-with-icon input[type="text"] {
      padding-left: 32px;
    }
    
    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
    }
    
    .btn {
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    /* ULTRA COMPACT TABLE */
    .table-container {
      background: var(--glass);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .table-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: var(--glass-dark);
    }
    
    .table-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .table-title i {
      color: var(--primary-color);
      font-size: 14px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      vertical-align: middle;
    }
    
    th {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    th i {
      margin-right: 4px;
      font-size: 9px;
    }
    
    tbody tr {
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    tbody tr:hover {
      background: rgba(37, 99, 235, 0.04);
      transform: scale(1.002);
    }
    
    tbody tr:nth-child(even) {
      background: rgba(248, 250, 252, 0.5);
    }
    
    tbody tr:nth-child(even):hover {
      background: rgba(37, 99, 235, 0.04);
    }
    
    tbody td {
      font-size: 11px;
      color: var(--text-primary);
      font-weight: 400;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .btn-sm {
      padding: 6px 10px;
      font-size: 10px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }
    
    .btn-success:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }
    
    /* ENHANCED GLASSMORPHISM POPUP STYLES */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255, 255, 255, 0.15);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(20px) saturate(180%);
      animation: overlayFadeIn 0.3s ease-out;
      padding: 16px;
    }
    
    @keyframes overlayFadeIn {
      from { opacity: 0; backdrop-filter: blur(0px); }
      to { opacity: 1; backdrop-filter: blur(20px) saturate(180%); }
    }
    
    .popup-content {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(40px) saturate(200%);
      padding: 24px;
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 450px;
      box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(255, 255, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      animation: popupSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      max-height: 85vh;
      overflow-y: auto;
    }
    
    .popup-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }
    
    @keyframes popupSlideUp {
      from { opacity: 0; transform: translateY(40px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .popup-content h3 {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 20px;
      text-align: center;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .popup-info {
      background: rgba(37, 99, 235, 0.08);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      border: 1px solid rgba(37, 99, 235, 0.15);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .popup-info p {
      margin-bottom: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
    }
    
    .popup-info strong {
      color: var(--text-primary);
      font-weight: 700;
    }
    
    .popup-info span {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }
    
    .popup-content select, 
    .popup-content textarea, 
    .popup-content input {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--radius-md);
      font-size: 12px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .popup-content select:focus, 
    .popup-content textarea:focus, 
    .popup-content input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .popup-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    
    .popup-buttons .btn {
      backdrop-filter: blur(10px);
      font-weight: 600;
    }
    
    .popup-buttons .btn-secondary {
      background: rgba(255, 255, 255, 0.7);
      color: var(--text-primary);
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .popup-buttons .btn-secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-primary);
      border-color: var(--primary-color);
    }
    
    .popup-buttons .btn-primary {
      background: var(--gradient-primary);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }
    
    /* COMPACT POPUP ENHANCED GLASS */
    .popup-content.compact {
      padding: 20px !important;
      max-width: 380px !important;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(40px) saturate(200%);
    }
    
    .popup-content.compact h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: var(--text-primary);
      font-weight: 800;
    }
    
    .compact-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(37, 99, 235, 0.05);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-md);
      border: 1px solid rgba(37, 99, 235, 0.1);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .compact-row strong {
      color: var(--text-primary);
      font-weight: 700;
    }
    
    .compact-row span {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .checkbox-group {
      display: flex;
      gap: 16px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-primary);
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }
    
    .checkbox-item input[type="checkbox"],
    .checkbox-item input[type="radio"] {
      width: 14px;
      height: 14px;
      accent-color: var(--primary-color);
      cursor: pointer;
    }
    
    .popup-content.compact input[type="datetime-local"],
    .popup-content.compact input[type="url"],
    .popup-content.compact select {
      font-size: 11px !important;
      padding: 8px 10px !important;
    }
    
    /* WHATSAPP BUTTON - HIDDEN BY DEFAULT */
    #waFloatBtn {
      position: fixed;
      right: 20px;
      top: 20px;
      display: none !important;
      text-decoration: none;
      background: linear-gradient(135deg, #25D366, #128C7E);
      color: #fff;
      padding: 12px 16px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 11px;
      box-shadow: var(--shadow-lg);
      z-index: 2000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      align-items: center;
      gap: 6px;
    }
    
    #waFloatBtn.show {
      display: flex !important;
      animation: whatsappSlideIn 0.5s ease-out;
    }
    
    @keyframes whatsappSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.8); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    #waFloatBtn:hover {
      background: linear-gradient(135deg, #128C7E, #25D366);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 30px -10px rgba(37, 211, 102, 0.4);
    }
    
    #waFloatBtn i {
      font-size: 14px;
    }
    
    /* STATUS BADGES - More Compact */
    .status-badge {
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-selected {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .status-rejected {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .status-hold {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    /* LOADING STATES */
    .loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px;
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { opacity: 0.6; }
      to { opacity: 1; }
    }
    
    /* RESPONSIVE - More Compact */
    @media (max-width: 1200px) {
      .filters {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
    }
    
    @media (max-width: 768px) {
      #dashboard {
        padding: 12px;
      }
      
      .filters {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .dashboard-header {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .dashboard-header h2 {
        font-size: 20px;
      }
      
      .filters-container {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      table {
        min-width: 900px;
      }
      
      th, td {
        padding: 6px 8px;
        font-size: 10px;
      }
      
      .popup-content {
        margin: 12px;
        padding: 20px;
      }
      
      .popup-content.compact {
        max-width: 95vw !important;
        padding: 16px !important;
      }
      
      .popup-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }

      .home-button {
        top: 15px;
        left: 15px;
        width: 45px;
        height: 45px;
        font-size: 18px;
        border-radius: 22.5px;
      }
    }
    
    @media (max-width: 480px) {
      .dashboard-header h2 {
        font-size: 18px;
      }
      
      .table-header {
        padding: 12px 16px;
      }
      
      .table-title {
        font-size: 13px;
      }
      
      th, td {
        padding: 4px 6px;
      }
    }
    
    /* ACCESSIBILITY */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* FOCUS STYLES */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }
    
    /* PREMIUM SCROLLBAR */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--background-tertiary);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>

<!-- Home Button -->
<button class="home-button" onclick="goHome()" title="Home">
  🏠
</button>

<!-- Dashboard -->
<div id="dashboard">
  <div class="dashboard-header">
    <h2><i class="fas fa-users-cog"></i> TCC Candidate Management</h2>
    <p class="dashboard-subtitle">Streamlined candidate tracking and communication</p>
  </div>
  
  <div class="filters-container">
    <h3 class="filters-title">
      <i class="fas fa-filter"></i>
      Search & Filters
    </h3>
    <div class="filters">
      <div class="filter-group">
        <label>Search Candidate</label>
        <div class="input-with-icon">
          <i class="fas fa-search"></i>
          <input type="text" id="nameSearch" placeholder="Enter name..." />
        </div>
      </div>
      
      <div class="filter-group">
        <label>&nbsp;</label>
        <button class="btn btn-primary" id="searchButton" onclick="applyFilters(true)">
          <i class="fas fa-search"></i>
          <span class="btn-text">Search</span>
        </button>
      </div>
      
      <div class="filter-group">
        <label>Company</label>
        <select id="companySelect" onchange="applyFilters()">
          <option value="">All Companies</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Status</label>
        <select id="statusSelect" onchange="applyFilters()">
          <option value="">All Status</option>
        </select>
      </div>
    </div>
  </div>
  
  <div class="table-container">
    <div class="table-header">
      <h3 class="table-title">
        <i class="fas fa-table"></i>
        Candidate Database
      </h3>
    </div>
    <table id="candidateTable">
      <thead>
        <tr>
          <th><i class="fas fa-clock"></i> Updated</th>
          <th><i class="fas fa-user"></i> Name</th>
          <th><i class="fas fa-envelope"></i> Email</th>
          <th><i class="fas fa-briefcase"></i> Position</th>
          <th><i class="fas fa-user-tie"></i> Recruiter</th>
          <th><i class="fas fa-building"></i> Company</th>
          <th><i class="fas fa-flag"></i> Status</th>
          <th><i class="fas fa-phone"></i> Contact</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="8" class="loading">
          <i class="fas fa-spinner fa-spin"></i> 
          Loading candidates...
        </td></tr>
      </tbody>
    </table>
  </div>
  
  <!-- Status Update Popup -->
  <div class="popup-overlay" id="popup">
    <div class="popup-content">
      <h3><i class="fas fa-edit"></i> Update Status</h3>
      
      <div class="popup-info">
        <p><strong>Name:</strong> <span id="popupCandidateName"></span></p>
        <p><strong>Company:</strong> <span id="popupCompany"></span></p>
        <p><strong>Position:</strong> <span id="popupPosition"></span></p>
      </div>
      
      <div class="form-group">
        <label for="statusDropdown"><i class="fas fa-flag"></i> Status</label>
        <select id="statusDropdown" onchange="updateFinalStatusOptions()">
          <option value="">Select Status</option>
          <option value="Selected">Selected</option>
          <option value="Rejected">Rejected</option>
          <option value="On Hold">On Hold</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="finalStatusDropdown"><i class="fas fa-check-circle"></i> Final Status</label>
        <select id="finalStatusDropdown">
          <option value="">Select Final Status</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="commentBox"><i class="fas fa-comment"></i> Comment</label>
        <textarea id="commentBox" rows="2" placeholder="Optional comment..."></textarea>
      </div>
      
      <div class="popup-buttons">
        <button class="btn btn-secondary" onclick="closePopup()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="btn btn-primary" id="statusSubmitButton" onclick="submitFinalStatusUpdate()">
          <i class="fas fa-save"></i>
          <span class="btn-text">Update</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Interview Scheduling Popup -->
  <div class="popup-overlay" id="extraPopup">
    <div class="popup-content compact">
      <h3><i class="fas fa-calendar-plus"></i> Schedule Interview</h3>
      
      <div class="compact-row">
        <strong><i class="fas fa-user"></i> Candidate:</strong>
        <span id="extraCandidateName"></span>
      </div>
      
      <div class="compact-row">
        <span><i class="fas fa-paper-plane"></i> Send via:</span>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" id="sendEmail"> 
            <i class="fas fa-envelope"></i> Email
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="sendWhatsapp"> 
            <i class="fab fa-whatsapp"></i> WhatsApp
          </label>
        </div>
      </div>
      
      <div class="form-group">
        <label for="extraDateTime">
          <i class="fas fa-calendar-alt"></i> Date & Time
        </label>
        <input type="datetime-local" id="extraDateTime">
      </div>
      
      <div class="compact-row">
        <span><i class="fas fa-map-marker-alt"></i> Mode:</span>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="radio" name="interviewMode" value="physical" onclick="toggleMode()"> 
            <i class="fas fa-building"></i> Physical
          </label>
          <label class="checkbox-item">
            <input type="radio" name="interviewMode" value="online" onclick="toggleMode()"> 
            <i class="fas fa-video"></i> Online
          </label>
        </div>
      </div>
      
      <div id="locationBox" style="display:none;">
        <div class="form-group">
          <label for="locationSelect">
            <i class="fas fa-map-marker-alt"></i> Location
          </label>
          <select id="locationSelect">
            <option value="">Select Location</option>
          </select>
        </div>
      </div>
      
      <div id="inviteBox" style="display:none;">
        <div class="form-group">
          <label for="inviteLink">
            <i class="fas fa-link"></i> Meeting Link
          </label>
          <input type="url" id="inviteLink" placeholder="https://meet.google.com/xxx">
        </div>
      </div>
      
      <div class="popup-buttons">
        <button class="btn btn-secondary" onclick="closeExtraPopup()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="btn btn-primary" id="interviewSubmitButton" onclick="submitExtraPopup()">
          <i class="fas fa-paper-plane"></i>
          <span class="btn-text">Send Invitation</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- WhatsApp Float Button -->
<a id="waFloatBtn" href="#" target="_blank" rel="noopener">
  <i class="fab fa-whatsapp"></i>
  <span id="waButtonText">Send WhatsApp</span>
</a>

<script>
// Authentication and user data management
window.addEventListener('load', function() {
    console.log("Management page loaded - checking authentication...");
    
    // Get all user data from sessionStorage
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    const userEmail = sessionStorage.getItem('userEmail');
    const userName = sessionStorage.getItem('userName');
    const userContact = sessionStorage.getItem('userContact');
    const userDesignation = sessionStorage.getItem('userDesignation');
    const userType = sessionStorage.getItem('userType');
    const loginTime = sessionStorage.getItem('loginTime');
    
    // Check if user is authenticated
    if (isLoggedIn !== 'true') {
        alert("Session expired or not logged in. Redirecting to login page.");
        window.location.href = 'index.html';
        return;
    }
    
    // User is authenticated - display user info
    console.log('✓ User authenticated successfully');
    console.log('Complete User Details:', {
        name: userName,
        email: userEmail,
        contact: userContact,
        designation: userDesignation,
        userType: userType,
        loginTime: loginTime
    });
    
    // Set loggedInEmail to the authenticated user's email
    loggedInEmail = userEmail;
    
    // Store user data globally for easy access
    window.USER_DATA = {
        isLoggedIn: isLoggedIn === 'true',
        email: userEmail,
        name: userName,
        contact: userContact,
        designation: userDesignation,
        userType: userType,
        loginTime: loginTime
    };
    
    console.log('Complete user data available globally as window.USER_DATA:', window.USER_DATA);
    
    // Load dashboard with authenticated user's data
    loadDashboard();
});

// Global functions
function logout() {
    // Clear all session data
    sessionStorage.removeItem('isLoggedIn');
    sessionStorage.removeItem('userEmail');
    sessionStorage.removeItem('userName');
    sessionStorage.removeItem('userContact');
    sessionStorage.removeItem('userDesignation');
    sessionStorage.removeItem('userType');
    sessionStorage.removeItem('loginTime');
    sessionStorage.removeItem('userRowIndex');
    
    alert("Logged out successfully");
    window.location.href = 'index.html';
}

function goHome() {
    window.location.href = 'index.html';
}

// Helper function to get complete user data
function getUserData() {
    return {
        isLoggedIn: sessionStorage.getItem('isLoggedIn') === 'true',
        email: sessionStorage.getItem('userEmail'),
        name: sessionStorage.getItem('userName'),
        contact: sessionStorage.getItem('userContact'),
        designation: sessionStorage.getItem('userDesignation'),
        userType: sessionStorage.getItem('userType'),
        loginTime: sessionStorage.getItem('loginTime')
    };
}

// Original variables and functions (keeping existing logic intact)
let loggedInEmail = "";
let candidates = [];
let currentEmail = "";
let currentCandidate = null;
let locationRows = [];
let lastWhatsAppLink = "";
const postURL = "https://script.google.com/macros/s/AKfycbwAru_5iah71LYYqh5CNrdt13tNP2sWLy7yzhbnNel2Q1wsojRRTYgn_wawfLHttN9R/exec";
const dataURL = "https://script.google.com/macros/s/AKfycbwhlc_lnb2OaC-W1g2WGI0X15H4VmzykIg_FejVvucVqtEc-mO65vU1_QOPY0YBQ1HU/exec";

function getElement(id) {
  const element = document.getElementById(id);
  if (!element) {
    console.error(`Element with id '${id}' not found`);
  }
  return element;
}

const tableBody = document.querySelector("#candidateTable tbody");
const companySelect = getElement("companySelect");
const statusSelect = getElement("statusSelect");
const nameSearchInput = getElement("nameSearch");

// Enhanced button loading state
function setButtonLoading(buttonId, isLoading, loadingText = "Processing...") {
  const button = getElement(buttonId);
  if (!button) return;
  
  const btnText = button.querySelector('.btn-text');
  const icon = button.querySelector('i');
  
  if (isLoading) {
    button.disabled = true;
    if (btnText) btnText.textContent = loadingText;
    if (icon) {
      icon.className = 'loading-spinner';
    }
  } else {
    button.disabled = false;
    // Restore original content based on button type
    if (buttonId === 'searchButton') {
      if (btnText) btnText.textContent = 'Search';
      if (icon) icon.className = 'fas fa-search';
    } else if (buttonId === 'statusSubmitButton') {
      if (btnText) btnText.textContent = 'Update';
      if (icon) icon.className = 'fas fa-save';
    } else if (buttonId === 'interviewSubmitButton') {
      if (btnText) btnText.textContent = 'Send Invitation';
      if (icon) icon.className = 'fas fa-paper-plane';
    }
  }
}

function loadDashboard() {
  fetch(dataURL)
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      if (!Array.isArray(data)) {
        throw new Error("Expected array data");
      }
      candidates = data.filter(c => (c.recruiter || "").toLowerCase() === loggedInEmail.toLowerCase());
      loadCompanyOptions();
      loadStatusOptions();
      applyFilters();
    })
    .catch(err => {
      console.error("Error loading dashboard:", err);
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;"><i class="fas fa-exclamation-triangle" style="color: var(--error-color);"></i><br>Error loading data. Please refresh.</td></tr>';
      }
    });
}

function loadCompanyOptions() {
  if (!companySelect) return;
  const companies = [...new Set(candidates.map(c => c.company).filter(Boolean))];
  companySelect.innerHTML = '<option value="">All Companies</option>';
  companies.forEach(company => {
    const opt = document.createElement("option");
    opt.value = company;
    opt.textContent = company;
    companySelect.appendChild(opt);
  });
}

function loadStatusOptions() {
  if (!statusSelect) return;
  const statuses = [...new Set(candidates.map(c => (c.final_status || '').toLowerCase()).filter(Boolean))];
  statusSelect.innerHTML = '<option value="">All Status</option>';
  statuses.forEach(status => {
    const opt = document.createElement("option");
    opt.value = status;
    opt.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    statusSelect.appendChild(opt);
  });
}

function applyFilters(isNameSearch = false) {
  if (!companySelect || !statusSelect || !nameSearchInput) return;
  
  if (isNameSearch) {
    setButtonLoading('searchButton', true, 'Searching...');
  }
  
  const selectedCompany = companySelect.value;
  const selectedStatus = statusSelect.value;
  const nameQuery = nameSearchInput.value.toLowerCase().trim();
  
  // Simulate search delay for better UX
  setTimeout(() => {
    const filtered = candidates.filter(c => {
      const matchCompany = !selectedCompany || c.company === selectedCompany;
      const matchStatus = !selectedStatus || (c.final_status || '').toLowerCase() === selectedStatus;
      const matchName = isNameSearch ? (c.name || '').toLowerCase().includes(nameQuery) : true;
      return matchCompany && matchStatus && matchName;
    });
    
    renderTable(filtered);
    if (isNameSearch) {
      setButtonLoading('searchButton', false);
    }
  }, isNameSearch ? 500 : 0);
}

function formatTimestamp(ts) {
  if (!ts) return "N/A";
  try {
    const date = new Date(ts);
    if (isNaN(date.getTime())) return ts;
    
    const dd = String(date.getDate()).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const yy = String(date.getFullYear()).slice(-2);
    let hours = date.getHours();
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12;
    
    return `${dd}/${mm}/${yy}`;
  } catch (error) {
    console.error("Error formatting timestamp:", error);
    return ts;
  }
}

function formatInterviewDT(dt) {
  if (!dt) return "N/A";
  try {
    const d = new Date(dt);
    if (isNaN(d.getTime())) return dt;
    
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = String(d.getFullYear()).slice(-2);
    let h = d.getHours();
    const m = String(d.getMinutes()).padStart(2,'0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    
    return `${dd}-${mm}-${yy} ${h}:${m} ${ampm}`;
  } catch (error) {
    console.error("Error formatting interview date:", error);
    return dt;
  }
}

function getVal(obj, ...keys) {
  if (!obj) return "";
  for (const k of keys) {
    if (obj[k] != null && obj[k] !== "") return obj[k];
  }
  return "";
}

function escapeHtml(unsafe) {
  return (unsafe || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function getStatusBadge(status) {
  if (!status) return '';
  const lowerStatus = status.toLowerCase();
  let badgeClass = 'status-badge';
  
  if (lowerStatus.includes('select') || lowerStatus.includes('shortlist')) {
    badgeClass += ' status-selected';
  } else if (lowerStatus.includes('reject')) {
    badgeClass += ' status-rejected';
  } else if (lowerStatus.includes('hold')) {
    badgeClass += ' status-hold';
  }
  
  return `<span class="${badgeClass}">${status}</span>`;
}

function renderTable(data) {
  if (!tableBody) return;
  tableBody.innerHTML = "";
  if (data.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;"><i class="fas fa-search" style="color: var(--text-tertiary);"></i><br>No candidates found</td></tr>';
    return;
  }
  data.forEach((c, idx) => {
    const row = document.createElement("tr");
    const safeName = escapeHtml(c.name || "");
    
    row.innerHTML = `
      <td title="${formatTimestamp(c.timestamp)}">${formatTimestamp(c.timestamp)}</td>
      <td title="${safeName}"><strong>${safeName}</strong></td>
      <td title="${escapeHtml(c.email || '')}">${escapeHtml(c.email || "")}</td>
      <td title="${escapeHtml(c.position || '')}">${escapeHtml(c.position || "")}</td>
      <td>${escapeHtml((c.recruiter || '').split("@")[0])}</td>
      <td title="${escapeHtml(c.company || '')}">${escapeHtml(c.company || "")}</td>
      <td>${getStatusBadge(c.final_status || '')}</td>
      <td><button class="btn btn-success btn-sm" onclick="event.stopPropagation(); openExtraPopup(${idx})" title="Schedule Interview">
        <i class="fas fa-phone"></i> Contact
      </button></td>
    `;
    
    row.addEventListener("click", () => openPopup(c));
    tableBody.appendChild(row);
  });
}

function openPopup(candidate) {
  currentEmail = candidate.email;
  const elements = {
    candidateName: getElement("popupCandidateName"),
    company: getElement("popupCompany"),
    position: getElement("popupPosition"),
    statusDropdown: getElement("statusDropdown"),
    finalStatusDropdown: getElement("finalStatusDropdown"),
    commentBox: getElement("commentBox"),
    popup: getElement("popup")
  };
  if (elements.candidateName) elements.candidateName.textContent = candidate.name || "";
  if (elements.company) elements.company.textContent = candidate.company || "";
  if (elements.position) elements.position.textContent = candidate.position || "";
  if (elements.statusDropdown) elements.statusDropdown.value = "";
  if (elements.finalStatusDropdown) elements.finalStatusDropdown.innerHTML = '<option value="">Select Final Status</option>';
  if (elements.commentBox) elements.commentBox.value = "";
  if (elements.popup) elements.popup.style.display = "flex";
}

function closePopup() {
  const popup = getElement("popup");
  if (popup) popup.style.display = "none";
}

function updateFinalStatusOptions() {
  const statusDropdown = getElement("statusDropdown");
  const finalStatusDropdown = getElement("finalStatusDropdown");
  if (!statusDropdown || !finalStatusDropdown) return;
  const status = statusDropdown.value;
  finalStatusDropdown.innerHTML = '<option value="">Select Final Status</option>';
  const statusOptions = {
    "Selected": ["Shortlisted", "L1 Selected", "L2 Selected", "L3 Selected", "Final Select"],
    "Rejected": ["Not Shortlisted", "L1 Reject", "L2 Reject", "L3 Reject"],
    "On Hold": ["Position On Hold", "Candidate On Hold"]
  };
  (statusOptions[status] || []).forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    finalStatusDropdown.appendChild(opt);
  });
}

function submitFinalStatusUpdate() {
  const statusDropdown = getElement("statusDropdown");
  const finalStatusDropdown = getElement("finalStatusDropdown");
  const commentBox = getElement("commentBox");
  if (!statusDropdown || !finalStatusDropdown || !commentBox) {
    alert("Form elements not found");
    return;
  }
  const status = statusDropdown.value;
  const finalStatus = finalStatusDropdown.value;
  const comment = commentBox.value;
  if (!currentEmail || !status || !finalStatus) {
    alert("Please select both status and final status.");
    return;
  }
  
  setButtonLoading('statusSubmitButton', true, 'Updating...');
  
  fetch(postURL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: currentEmail, status, final_status: finalStatus, comment })
  })
  .then(() => {
    setTimeout(() => {
      alert("Status updated successfully!");
      closePopup();
      setButtonLoading('statusSubmitButton', false);
      loadDashboard();
    }, 1000);
  })
  .catch(error => {
    console.error("Fetch failed:", error);
    setTimeout(() => {
      alert("Update failed. Please try again.");
      setButtonLoading('statusSubmitButton', false);
    }, 1000);
  });
}

function toggleMode() {
  const mode = document.querySelector('input[name="interviewMode"]:checked')?.value;
  const locationBox = getElement("locationBox");
  const inviteBox = getElement("inviteBox");
  if (locationBox) locationBox.style.display = (mode === "physical") ? "block" : "none";
  if (inviteBox) inviteBox.style.display = (mode === "online") ? "block" : "none";
}

async function fetchLocations(candidateCompany) {
  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbzRSZ-zWCCwT57z1t2XHBMvwJcyyQsqZooA2i6U42ktVFEOrTVl3_OhNkgZcmolJJUV/exec");
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    locationRows = Array.isArray(data) ? data : [];
    const select = getElement("locationSelect");
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Location</option>';
    const want = (candidateCompany || "").toString().trim().toLowerCase();
    const vendorMatches = locationRows.filter(r => {
      const code = (r.Company_code ?? r.Company_Code ?? r.company_code ?? "").toString().trim().toLowerCase();
      return code && code === want;
    });
    const locations = [...new Set(
      vendorMatches
        .map(r => (r.office_locations ?? r.Office_Locations ?? r.Location ?? "").toString().trim())
        .filter(Boolean)
    )];
    if (locations.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No locations available";
      select.appendChild(opt);
      return;
    }
    locations.forEach(loc => {
      const opt = document.createElement("option");
      opt.value = loc;
      opt.textContent = loc;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Error fetching locations:", err);
    locationRows = [];
  }
}

function openExtraPopup(idx) {
  const extraCandidateName = getElement("extraCandidateName");
  const extraPopup = getElement("extraPopup");
  const sendEmail = getElement("sendEmail");
  const sendWhatsapp = getElement("sendWhatsapp");
  const extraDateTime = getElement("extraDateTime");
  const locationSelect = getElement("locationSelect");
  const inviteLink = getElement("inviteLink");
  const waBtn = getElement("waFloatBtn");
  
  // Get candidate from current filtered list
  const currentFilteredCandidates = candidates.filter(c => {
    const selectedCompany = companySelect ? companySelect.value : "";
    const selectedStatus = statusSelect ? statusSelect.value : "";
    const nameQuery = nameSearchInput ? nameSearchInput.value.toLowerCase().trim() : "";
    const matchCompany = !selectedCompany || c.company === selectedCompany;
    const matchStatus = !selectedStatus || (c.final_status || '').toLowerCase() === selectedStatus;
    const matchName = nameQuery ? (c.name || '').toLowerCase().includes(nameQuery) : true;
    return matchCompany && matchStatus && matchName;
  });
  currentCandidate = currentFilteredCandidates[idx] || null;
  if (!currentCandidate) { 
    alert("Candidate not found."); 
    return; 
  }
  if (extraCandidateName) extraCandidateName.textContent = currentCandidate.name || "";
  
  // Reset form
  if (sendEmail) sendEmail.checked = false;
  if (sendWhatsapp) sendWhatsapp.checked = false;
  if (extraDateTime) extraDateTime.value = "";
  if (inviteLink) inviteLink.value = "";
  if (locationSelect) locationSelect.innerHTML = '<option value="">Select Location</option>';
  if (waBtn) { 
    waBtn.classList.remove('show');
    waBtn.href = "#"; 
  }
  lastWhatsAppLink = "";
  
  // Default to Physical mode
  const radios = document.querySelectorAll('input[name="interviewMode"]');
  radios.forEach(r => r.checked = false);
  const physicalRadio = Array.from(radios).find(r => r.value === "physical");
  if (physicalRadio) physicalRadio.checked = true;
  toggleMode();
  
  // Fetch locations for candidate's company
  if (currentCandidate && currentCandidate.company) {
    fetchLocations(currentCandidate.company);
  }
  if (extraPopup) extraPopup.style.display = "flex";
}

function closeExtraPopup() {
  const extraPopup = getElement("extraPopup");
  if (extraPopup) extraPopup.style.display = "none";
}

function onlyDigits(s) { 
  return (s || "").toString().replace(/\D/g, ""); 
}

async function submitExtraPopup() {
  const extraCandidateName = getElement("extraCandidateName");
  const extraDateTime = getElement("extraDateTime");
  const sendEmail = getElement("sendEmail");
  const sendWhatsapp = getElement("sendWhatsapp");
  const locationSelect = getElement("locationSelect");
  const inviteLink = getElement("inviteLink");
  if (!extraCandidateName || !extraDateTime || !sendEmail || !sendWhatsapp) {
    alert("Required form elements not found");
    return;
  }
  const rawMode = document.querySelector('input[name="interviewMode"]:checked')?.value;
  const mode = rawMode === "physical" || rawMode === "online" ? rawMode : null;
  if (!mode) {
    alert("Please select interview mode (Physical or Online).");
    return;
  }
  const dt = extraDateTime.value;
  if (!dt) {
    alert("Please select interview date & time.");
    return;
  }
  const isoDt = new Date(dt).toISOString();
  const emailChecked = sendEmail.checked;
  const whatsappChecked = sendWhatsapp.checked;
  let loc = null;
  if (mode === "physical") {
    const selectedLoc = (locationSelect?.value || "").toString().trim();
    if (!selectedLoc) {
      alert("Please select a physical location.");
      return;
    }
    
    const normalize = str => (str || "").toString().trim().toLowerCase();
    const targetLocation = normalize(selectedLoc);
    
    loc = (locationRows || []).find(r => {
      const locName = normalize(r.office_locations ?? r.Office_Locations ?? r.Location ?? "");
      return locName === targetLocation;
    });
    
    if (!loc) {
      alert("Selected location not found in configuration. Please try again.");
      return;
    }
  } else if (mode === "online") {
    const linkVal = (inviteLink?.value || "").trim();
    if (!linkVal) {
      alert("Please enter an online meeting link.");
      return;
    }
  }
  
  setButtonLoading('interviewSubmitButton', true, 'Sending...');
  
  const mobile = onlyDigits(
    currentCandidate?.Mobile || currentCandidate?.mobile ||
    currentCandidate?.phone || currentCandidate?.Phone || ""
  );
  
  // Use logged-in user's name instead of hardcoded recruiter
  const userData = getUserData();
  const recruiterName = userData.name || (loggedInEmail || "").split("@")[0] || "Recruiter";
  
  // SAFE PAYLOAD - Ensure no undefined values
  const payload = {
    candidate_name: String(currentCandidate?.name || ""),
    candidate_email: String(currentCandidate?.email || ""),
    candidate_phone: String(mobile || ""),
    candidate_company: String(currentCandidate?.company || ""),
    candidate_position: String(currentCandidate?.position || ""),
    recruiter: String(recruiterName || ""),
    interview_mode: String(mode || ""),
    interview_datetime: String(isoDt || "")
  };
  
  // Only add location fields if physical mode
  if (mode === "physical" && loc) {
    payload.location_company_name = String(loc?.Company_Name || loc?.company_name || "");
    payload.location_spoc_name = String(loc?.Spoc_Name || loc?.spoc_name || "");
    payload.location_spoc_number = String(loc?.Spoc_Number || loc?.spoc_number || "");
    payload.location_address = String(loc?.Address || loc?.address || "");
    payload.location_google_map = String(loc?.Google_Map || loc?.google_map || "");
  }
  
  // Only add invite link if online mode
  if (mode === "online") {
    payload.invite_link = String((inviteLink?.value || "").trim());
  }
  
  // WhatsApp message (unchanged)
  if (whatsappChecked && mobile) {
    let msg = `*Hi ${currentCandidate?.name}*,\n\n` +
              `We are pleased to schedule your interview for the *${currentCandidate?.position || ""}* role at *${currentCandidate?.company || ""}*.\n\n` +
              `*Interview Details:*\n` +
              `📅 *Date & Time:* ${formatInterviewDT(dt)}\n` +
              `💼 *Mode:* ${mode.toUpperCase()}\n\n`;
    
    if (mode === "physical" && loc) {
      msg += `*Company Details:*\n` +
             `🏢 *Company:* ${getVal(loc,"Company_Name","company_name")}\n` +
             `👤 *HR Name:* ${getVal(loc,"Spoc_Name","spoc_name")}\n` +
             `📞 *HR Contact:* +91 ${getVal(loc,"Spoc_Number","spoc_number")}\n` +
             `📍 *Address:* ${getVal(loc,"Address","address")}\n` +
             `🗺 *Google Map:* ${getVal(loc,"Google_Map","google_map")}\n` +
             `\n*Note:*\n✅ Please carry your updated resume\n⏰ Be on time\n`;
    } else if (mode === "online") {
      msg += `🔗 *Meeting Link:* ${(inviteLink?.value || "").trim()}\n\n` +
             `*Kindly note: Join 5-10 mins before the interview starts.*\n`;
    }
    msg += `\n*Regards,*\n*${recruiterName}*\n*Talent Connect Consultancy*`;
    lastWhatsAppLink = `https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`;
    const waBtn = getElement("waFloatBtn");
    const waButtonText = getElement("waButtonText");
    if (waBtn && waButtonText) {
      waBtn.href = lastWhatsAppLink;
      waButtonText.textContent = `Send to ${currentCandidate?.name || "Candidate"}`;
      waBtn.classList.add('show');
    }
  }
  
  // Send to Power Automate
  if (emailChecked) {
    console.log("=== DEBUGGING POWER AUTOMATE CALL ===");
    console.log("Payload being sent:", JSON.stringify(payload, null, 2));
    console.log("Payload size:", JSON.stringify(payload).length, "bytes");
    
    const url = "https://default95bfece3066c4fa7b1004902edfde1.f3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4acbeedd695b453c953eef63041723b6/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=fMQ-vKxXAcsLpQJuoeyXaar8AN-RT-7xSx3c2nbdmN8";
    
    try {
      const response = await fetch(url, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      
      const responseText = await response.text();
      console.log("=== POWER AUTOMATE RESPONSE ===");
      console.log("Status:", response.status);
      console.log("Status Text:", response.statusText);
      console.log("Response Headers:", [...response.headers.entries()]);
      console.log("Response Body:", responseText);
      
      setTimeout(() => {
        if (!response.ok) {
          console.error("❌ Power Automate Error Details:");
          console.error("URL:", url);
          console.error("Method:", "POST");
          console.error("Headers:", { "Content-Type": "application/json" });
          console.error("Body:", JSON.stringify(payload, null, 2));
          alert(`Email service failed (${response.status}: ${response.statusText}). Check console for details.`);
          setButtonLoading('interviewSubmitButton', false);
          return;
        }
        
        console.log("✅ Email sent successfully");
        alert("Interview invitation sent successfully!");
        closeExtraPopup();
        setButtonLoading('interviewSubmitButton', false);
      }, 1200);
      
    } catch (err) {
      console.error("❌ Network/CORS Error:", err);
      setTimeout(() => {
        alert("Could not reach email service. Network error - check console.");
        setButtonLoading('interviewSubmitButton', false);
      }, 1200);
      return;
    }
  } else {
    // If only WhatsApp selected
    setTimeout(() => {
      alert("WhatsApp message prepared! Use the floating button to send.");
      closeExtraPopup();
      setButtonLoading('interviewSubmitButton', false);
    }, 800);
  }
}

// Enhanced keyboard event listeners
document.addEventListener('DOMContentLoaded', function() {
  const nameSearch = getElement("nameSearch");
  if (nameSearch) {
    nameSearch.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        applyFilters(true);
      }
    });
  }
});

console.log('Management page loaded with authentication integration');
</script>
</body>
</html>
